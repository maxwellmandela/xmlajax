<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>upesi</title>
        <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
        <link href="bootstrap.min.css" rel="stylesheet">
        <script src="bootstrap.min.js"></script>
        <script src="https://use.fontawesome.com/3277c51ba8.js"></script>
    </head>

    <style>
    #max{
        position: absolute;
        top: 0;
        margin-top: -1530px;
        left: 1%;
        height: 300px;
        width: 500px;
        z-index: 9999;
        background-color: blue;
    }
    </style>

    <body class="container">
        <div class="col-sm-6 col-sm-offset-3 jumbotron" style="margin-top:5%;">
            <select class="form-control" id="changecurrency">
                <option selected="selected" disabled="true">Select Currency</option>
                <option value="KES|+254">Kenya</option>
                <option value="RWF|+250">Rwanda</option>
                <option value="TZS|+255">Tanzania</option>
                <option value="UGX|+265">Uganda</option>
            </select>
            <p class="text text-center"><span id="newrate"><small>change currency to see rate</small></span></p>
            <div class="row">
                <div class="col-sm-6">
                    <!--<input type="text" class="form-control" id="send_amount" placeholder="Enter Send Amount">-->
                    <div class="input-group">
                        <input type="text" class="form-control" id="send_amount" placeholder="Enter Send Amount">
                        <span class="input-group-addon" id="do_send_amount">
                            <i id="spinner" class="fa fa-arrow-right" aria-hidden="true"></i>
                        </span>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="input-group">
                        <span class="input-group-addon" id="do_receive_amount">
                            <i id="spin" class="fa fa-arrow-left" aria-hidden="true"></i>
                        </span>
                        <input type="text" class="form-control" id="receive_amount" placeholder="Enter Receive Amount">
                    </div>
                </div>
            </div>
            <p id="process" class="text text-center"></p>
            <br>

            <!-- Trigger the modal with a button -->
            <div class="row">
                <div class="col-sm-6">
                    <button type="button" class="btn btn-success btn-block" data-toggle="modal" data-target="#loginModal">Sign In</button>
                </div>
                <div class="col-sm-6">
                    <button type="button" class="btn btn-warning btn-block" data-toggle="modal" data-target="#registerModal">Create Free Account</button>
                </div>
            </div>
            <br>

            <p>Transaction Tracker</p>
            <div class="row">
                <div class="col-sm-6">
                    <input type="email" class="form-control" id="transaction_tracker" placeholder="Transaction Number">
                </div>
                <div class="col-sm-6">
                    <button type="button" class="btn btn-warning btn-block">Track</button>
                </div>
            </div>

            <!--Login Modal -->
            <div id="loginModal" class="modal fade" role="dialog">
              <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Sign In</h4>
                    <small>Sign in using your registered account:</small>
                  </div>
                  <div class="modal-body">
                    <formm class="form-horizontal" role="form" autocomplete="off" method="post" action="">
                      <div class="form-group">
                        <label class="control-label col-sm-2" for="email">Email:</label>
                        <div class="col-sm-10">
                          <input type="email" class="form-control" id="email" placeholder="Enter email" autocomplete="off">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-sm-2" for="password">Password:</label>
                        <div class="col-sm-10">
                          <input type="password" class="form-control" id="password" placeholder="Enter password" autocomplete="off">
                        </div>
                      </div>
                      <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                          <div class="checkbox">
                            <label><input type="checkbox"> Remember me</label>
                          </div>
                        </div>
                      </div>
                      <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                          <button type="submit" class="btn btn-warning" id="sign_in">Sign In</button>
                        </div>
                      </div>
                    </formm>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                  </div>
                </div>

              </div>
            </div>

            <!-- Register Modal -->
            <div id="registerModal" class="modal fade" role="dialog">
          <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Create Your Account</h4>
                <small>Create your free account:</small>
              </div>
              <div class="modal-body">
                <formm class="form-horizontal" role="form" autocomplete="off">
                  <div class="form-group">
                    <label class="control-label col-sm-2" for="first_name">Name:</label>
                    <div class="col-sm-5">
                      <input type="text" class="form-control" id="first_name" placeholder="Enter first name">
                    </div>
                    <div class="col-sm-5">
                      <input type="text" class="form-control" id="last_name" placeholder="Enter last name">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="control-label col-sm-2" for="address">Address:</label>
                    <div class="col-sm-5">
                      <input type="text" class="form-control" id="address" placeholder="Enter Address">
                    </div>
                    <div class="col-sm-5">
                      <input type="text" class="form-control" id="zip" placeholder="Enter Zip Code">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="control-label col-sm-2" for="country">Country:</label>
                    <div class="col-sm-5">
                      <select class="form-control" id="country">
                        <option value="Kenya">Kenya</option>
                        <option value="Rwanda">Rwanda</option>
                        <option value="Tanzania">Tanzania</option>
                        <option value="Uganda">Uganda</option>
                        <option value="United States">United States</option>
                      </select>
                    </div>
                    <div class="col-sm-5">
                      <input type="text" class="form-control" id="reg_emailcity" placeholder="City/Town">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="control-label col-sm-2" for="reg_email">Email:</label>
                    <div class="col-sm-10">
                      <input type="email" class="form-control" id="reg_email" placeholder="Enter email">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="control-label col-sm-2" for="reg_password">Password:</label>
                    <div class="col-sm-5"> 
                      <input type="password" class="form-control" id="reg_password" placeholder="Enter password">
                    </div>
                    <div class="col-sm-5"> 
                      <input type="password" class="form-control" id="password_confirm" placeholder="Confirm password">
                    </div>
                  </div>
                  <div class="form-group"> 
                    <div class="col-sm-offset-2 col-sm-10">
                      <button type="submit" class="btn btn-inverse" id="sign_up">Register</button>
                    </div>
                  </div>
                </formm>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
              </div>
            </div>

          </div>
        </div>

        </div>

        <script>
            $("#changecurrency").change(function(){
              var currencies = $("#changecurrency").val();
              var curr = currencies.split('|');
              var currency_symbol = curr[0];
              var country_code = curr[1];

              localStorage.setItem("current_currency", currency_symbol);
              localStorage.setItem("country_code", country_code);

              $.ajax({
                type: "GET",
                url: "getExchangeRate.php?currency="+currency_symbol,
                success: function(xmlResponse) {
                  //console.log(xmlResponse);
                  var rate = JSON.parse(xmlResponse);
                  var rate = eval(rate.Rate);
                  $("#newrate").html("1$ = "+rate+ " "+currency_symbol);
                },
                error: function(){
                  alert("error processing");
                }
              });
            });

            $("#do_send_amount").click(function(){
                $("#spinner").addClass("fa-spinner");
              if ($.isNumeric($("#send_amount").val()) && localStorage.getItem("current_currency") !== null) {
                 var principle_amount = eval($("#send_amount").val());
                 var dest_curr = localStorage.getItem("current_currency");
                 var dest_curr_code = localStorage.getItem("country_code");
                 var newcharge =  "<GetMTCharge xmlns:i='http://www.w3.org/2001/XMLSchema-instance' xmlns='http://schemas.datacontract.org/2004/07/MTM.DTO'>"
                   +"<ClientPassword>String</ClientPassword>"
                   +"<ClientUsername>String</ClientUsername>"
                   +"<CompanyId>0</CompanyId>"
                   +"<CustomerId>0</CustomerId>"
                   +"<DestinationCountryCode>"+dest_curr_code+"</DestinationCountryCode>"
                   +"<DestinationCurrencyCode>"+dest_curr+"</DestinationCurrencyCode>"
                   +"<PayoutMethod>BankTransfer</PayoutMethod>"
                   +"<PrincipalAmount>"+$("#send_amount").val()+"</PrincipalAmount>"
                   +"<ServiceId>0</ServiceId>"
                 +"</GetMTCharge>";

                 //"+localStorage.getItem("current_currency")+"

                 var options={};
                  options.url="getCharge.php";
                  options.method="post";
                  options.data=newcharge;
                  options.contentType="text/xml";

                  $.ajax(options).done(function(data){
                    //console.log(data);
                    var charge = $(data).find('Message').text();
                      $.ajax({
                        type: "GET",
                        url: "getExchangeRate.php?currency="+localStorage.getItem("current_currency"),
                        success: function(xmlResponse) {
                          //console.log(xmlResponse);
                          var rate = JSON.parse(xmlResponse).Rate;
                          var tosend = (eval(charge)-principle_amount);
                          var toreceive = Math.abs((tosend*rate)).toFixed(4);
                          //console.log(tosend +" , "+toreceive);
                          $("#receive_amount").val(toreceive);
                        },
                        error: function(){
                            $("#spinner").removeClass("fa-spinner");
                            $("#process").html("error, try again later");
                        }
                      });
                      $("#spinner").removeClass("fa-spinner");
                      $("#process").html("");
                  }).error(function(){
                      $("#spinner").removeClass("fa-spinner");
                      $("#process").html("error, try again later");
                  });
              }
            });

            $("#do_receive_amount").click(function(){
                $("#spin").addClass("fa-spinner");
                if ($.isNumeric($("#receive_amount").val()) && localStorage.getItem("current_currency") !== null) {
                    var principle_amount = eval($("#receive_amount").val());
                    var dest_curr = localStorage.getItem("current_currency");
                    var dest_curr_code = localStorage.getItem("country_code");

                    $.ajax({
                        type: "GET",
                        url: "getExchangeRate.php?currency="+localStorage.getItem("current_currency"),
                        success: function(xmlResponse) {
                            //console.log(xmlResponse);
                            var rate = JSON.parse(xmlResponse).Rate;
                            var tosend = (principle_amount/rate);

                            //get charge
                            var newcharge =  "<GetMTCharge xmlns:i='http://www.w3.org/2001/XMLSchema-instance' xmlns='http://schemas.datacontract.org/2004/07/MTM.DTO'>"
                            +"<ClientPassword>String</ClientPassword>"
                            +"<ClientUsername>String</ClientUsername>"
                            +"<CompanyId>0</CompanyId>"
                            +"<CustomerId>0</CustomerId>"
                            +"<DestinationCountryCode>"+dest_curr_code+"</DestinationCountryCode>"
                            +"<DestinationCurrencyCode>"+dest_curr+"</DestinationCurrencyCode>"
                            +"<PayoutMethod>BankTransfer</PayoutMethod>"
                            +"<PrincipalAmount>"+tosend+"</PrincipalAmount>"
                            +"<ServiceId>0</ServiceId>"
                            +"</GetMTCharge>";

                            //"+localStorage.getItem("current_currency")+"

                            var options={};
                            options.url="getCharge.php";
                            options.method="post";
                            options.data=newcharge;
                            options.contentType="text/xml";

                            $.ajax(options).done(function(data){
                                //console.log(data);
                                var charge = eval($(data).find('Message').text());
                                $("#send_amount").val((tosend+charge).toFixed(4));
                            }).error(function(){
                                $("#spin").removeClass("fa-spinner");
                                $("#process").html("error, try again later");
                            });
                            $("#spin").removeClass("fa-spinner");
                            $("#process").html("");
                        },
                        error: function(){
                            $("#spin").removeClass("fa-spinner");
                            $("#process").html("error, try again later");
                        }
                    });
                }
            });

            $("#sign_in").click(function(){
                /*var login_data = "<ValidateLogin xmlns:i='http://www.w3.org/2001/XMLSchema-instance' xmlns='http://schemas.datacontract.org/2004/07/MTM.DTO'>"
                    +"<Email>"+$("#email").val()+"</Email>"
                    +"<Password>"+$("#password").val()+"</Password>"
                    +"</ValidateLogin>";

                var options={};
                options.url="validateLogin.php";
                options.method="post";
                options.data=login_data;
                options.contentType="text/xml";

                $.ajax(options).done(function(data) {
                    console.log(data);
                    var feedback = $(data).find('Message').first().text();
                    var msg = $(data).find('Result').first().text();
                    if(msg == "success"){
                        window.location.replace("http://demo.mtmlive.net/Customer/default.aspx");
                    }else{
                        alert(feedback);
                    }
                }).error(function(){
                    console.log("error");
                });*/
                $.ajax({
                    type: "GET",
                    url: 'http://demo.mtmlive.net/webservice/api/xml/reply/ValidateLogin',
                    data:{"Email":$('#email').val(), "Password":$("#password").val()},
                    async:true,
                    dataType : 'jsonp',   //you may use jsonp for cross origin request
                    crossDomain:true,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader ("Authorization", "Basic " + btoa("administrator:password"));
                    },
                    success: function(data, status, xhr) {
                        console.log(data.Message);
                        if(data.Result == 'success'){
                            window.location.replace("http://demo.mtmlive.net/Customer/default.aspx");
                        }
                    },
                    error: function(){
                        alert('error');
                    }
                });
            });

            $("#sign_up").click(function(){
                var reg_data = "<AddCustomer xmlns='http://schemas.datacontract.org/2004/07/MTM.DTO' xmlns:i='http://www.w3.org/2001/XMLSchema-instance'>"
                    +"    <ClientPassword>"+$("#reg_password").val()+"</ClientPassword>"
                    +"    <Password>"+$("#reg_password").val()+"</Password>"
                    +"    <Customer>"
                    +"        <Address1>"+$("#address").val()+"</Address1>"
                    +"        <City>"+$("#reg_emailcity").val()+"</City>"
                    +"        <Country>"+$("#country").val()+"</Country>"
                    +"        <EmailAddress>"+$("#reg_email").val()+"</EmailAddress>"
                    +"        <Firstname>"+$("#first_name").val()+"</Firstname>"
                    +"        <Middlename>"+$("#last_name").val()+"</Middlename>"
                    +"        <Password>"+$("#reg_password").val()+"</Password>"
                    +"        <State>"+$("#reg_password").val()+"</State>"
                    +"        <Zipcode>"+$("#zip").val()+"</Zipcode>"
                    +"    </Customer>"
                    +"</AddCustomer>";

                var options={};
                options.url="addCustomer.php";
                options.method="post";
                options.data=reg_data;
                options.contentType="text/xml";

                $.ajax(options).done(function(data) {
                    console.log(data);
                    var feedback = $(data).find('Message').first().text();
                    var msg = $(data).find('Result').first().text();

                    console.log(msg);
                }).error(function(){
                    console.log("error");
                });
            });
        </script>
    </body>
</html>